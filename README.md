# Tic-Tac-Toe REST API

Это REST API для игры в крестики-нолики на поле NxN с поддержкой специального правила: каждый третий ход существует 10% вероятность, что поставится значок противника.

## Архитектура

Приложение построено по классической трехслойной архитектуре:

1. **Слой представления (Controllers)**:
   - `GamesController` - обработка HTTP-запросов
   - Возвращает ответы в формате JSON
   - Обрабатывает ошибки согласно RFC 7807

2. **Слой бизнес-логики (Services)**:
   - `GameService` - основная логика игры
   - Проверка правил, обработка ходов
   - Определение победителя

3. **Слой данных (Repositories)**:
   - `GameRepository` - работа с базой данных
   - Использует Entity Framework Core
   - PostgreSQL в качестве СУБД

Дополнительно:
- Конфигурация через переменные окружения
- Поддержка Docker и docker-compose
- Интеграционные и unit-тесты
- Простой Web-интерфейс для тестирования

## Веб-интерфейс

Приложение включает простой HTML/JS интерфейс для удобного тестирования API. Интерфейс предоставляет:

1. Кнопку для создания новой игры
2. Визуализацию игрового поля
3. Отображение текущего состояния игры
4. Обработку ходов игроков
5. Отображение результатов игры (победа/ничья)

Особенности интерфейса:
- Адаптивное игровое поле (размер зависит от BOARD_SIZE)
- Подсветка текущего игрока
- Визуальное выделение победителя
- Обработка и отображение ошибок
- Защита от повторных кликов во время выполнения запроса

## Эндпоинты API

### 1. Создание новой игры

**POST /api/games**

Создает новую игру с полем размером NxN (N задается через переменную окружения BOARD_SIZE, по умолчанию 3).

Пример ответа:
```json
{
  "id": "3fa85f64-5717-4562-b3fc-2c963f66afa6",
  "board": [
    [null, null, null],
    [null, null, null],
    [null, null, null]
  ],
  "currentPlayer": "X",
  "winner": null,
  "moveCount": 0
}
```

### 2. Получение информации об игре

**GET /api/games/{id}**

Возвращает текущее состояние игры по ID.

Пример ответа:
```json
{
  "id": "3fa85f64-5717-4562-b3fc-2c963f66afa6",
  "board": [
    ["X", null, null],
    [null, "O", null],
    [null, null, null]
  ],
  "currentPlayer": "X",
  "winner": null,
  "moveCount": 2
}
```

### 3. Совершение хода

**POST /api/games/{id}/moves**

Принимает ход игрока и обновляет состояние игры.

Тело запроса:
```json
{
  "player": "X",
  "row": 0,
  "col": 1
}
```

Пример ответа:
```json
{
  "id": "3fa85f64-5717-4562-b3fc-2c963f66afa6",
  "board": [
    ["X", "X", null],
    [null, "O", null],
    [null, null, null]
  ],
  "currentPlayer": "O",
  "winner": null,
  "moveCount": 3
}
```

### 4. Проверка здоровья

**GET /health**

Возвращает 200 OK, если сервис работает.

## Особые правила

1. **Специальное правило**: Каждый третий ход (moveCount % 3 == 2) существует 10% вероятность, что поставится значок противника.

2. **Условия победы**: Количество символов в ряд для победы задается через переменную окружения WIN_CONDITION (по умолчанию равно размеру поля).

## Переменные окружения

| Переменная | Описание | Значение по умолчанию |
|------------|----------|----------------------|
| BOARD_SIZE | Размер игрового поля (N) | 3 |
| WIN_CONDITION | Количество символов в ряд для победы | 3 (равно BOARD_SIZE) |
| ConnectionStrings__DefaultConnection | Строка подключения к PostgreSQL | Host=db;Database=tictactoe;Username=postgres;Password=postgres |

## Запуск приложения

### 1. Локальный запуск (с Docker)

1. Убедитесь, что у вас установлены Docker и docker-compose
2. Клонируйте репозиторий
3. Выполните команду:
   ```bash
   docker-compose up --build
   ```
4. Приложение будет доступно по адресу: http://localhost:8080
   - API: http://localhost:8080/api/games
   - Web-интерфейс: http://localhost:8080/index.html

### 2. Локальный запуск (без Docker)

1. Убедитесь, что у вас установлены .NET 9 SDK и PostgreSQL
2. Создайте базу данных и обновите строку подключения в appsettings.json
3. Выполните команды:
   ```bash
   dotnet restore
   dotnet run
   ```
4. Приложение будет доступно по адресу: http://localhost:8080
   - Web-интерфейс: http://localhost:8080/index.html

### 3. Запуск тестов

Для запуска тестов выполните:
```bash
dotnet test
```

## Технические особенности

1. **Идемпотентность**: Повторные POST-запросы с одинаковым телом возвращают тот же результат
2. **Устойчивость к сбоям**: Состояние игры сохраняется при перезапуске
3. **Валидация**: Проверка корректности входных данных и правил игры
4. **Логирование**: Подробное логирование ошибок и событий
5. **Web-интерфейс**: Простой UI для тестирования функциональности

## Примеры использования через Web-интерфейс

1. Нажмите кнопку "New Game" для создания новой игры
2. Кликайте по клеткам поля, чтобы сделать ход
3. Интерфейс автоматически:
   - Отображает текущего игрока
   - Показывает сделанные ходы
   - Сообщает о победе или ничье
   - Выводит ошибки при некорректных действиях

Для прямого взаимодействия с API можно использовать cURL или другие HTTP-клиенты, как описано в предыдущих разделах.